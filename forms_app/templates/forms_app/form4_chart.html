<!-- templates/forms_app/form4_chart.html -->
{% extends "forms_app/base_form.html" %} {% block title %}–ì—Ä–∞—Ñ–∏–∫:
{{code}}{%endblock%} {% block content %}
<h2>
  üìà –ì—Ä–∞—Ñ–∏–∫ ‚Äî {{ code }} |
  <span style="font-size: 0.9em; color: #555">{{ article|default:"‚Äî" }}</span> |
  {{ label }}
</h2>
<!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç -->
<form
  method="GET"
  style="
    margin-bottom: 20px;
    padding: 15px;
    background: #f1f3f5;
    border-radius: 8px;
  "
>
  <label for="start_date" style="margin-right: 10px">
    <strong>–ù–∞—á–∞–ª–æ:</strong>
    <input
      type="date"
      id="start_date"
      name="start_date"
      value="{{ start_date }}"
      style="padding: 5px; border: 1px solid #ccc; border-radius: 4px"
    />
  </label>

  <label for="end_date" style="margin-right: 10px">
    <strong>–ö–æ–Ω–µ—Ü:</strong>
    <input
      type="date"
      id="end_date"
      name="end_date"
      value="{{ end_date }}"
      style="padding: 5px; border: 1px solid #ccc; border-radius: 4px"
    />
  </label>

  <button
    type="submit"
    style="
      padding: 6px 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    "
  >
    üìÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å
  </button>

  <a
    href="{% if chart_type == 'profit' %}{% url 'forms_app:form4_chart' code=code %}{% else %}{% url 'forms_app:form4_chart_type' code=code chart_type=chart_type %}{% endif %}"
    style="margin-left: 10px; color: #666; font-size: 0.9em"
  >
    –°–±—Ä–æ—Å–∏—Ç—å
  </a>
</form>

{% if dates %}
<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤—ã—Å–æ—Ç–æ–π -->
<div style="height: 400px; position: relative; margin: 20px 0">
  <canvas id="chartCanvas"></canvas>
</div>

<!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->

<div
  style="
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
  "
>
  <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π:</strong> {{ dates|length }}</p>
  
  {% if chart_type == 'profit' %}
  <div style="background: {% if total_profit >= 0 %}#d4edda{% else %}#f8d7da{% endif %}; 
              padding: 10px; 
              border-radius: 5px; 
              margin: 10px 0;
              border: 1px solid {% if total_profit >= 0 %}#c3e6cb{% else %}#f5c6cb{% endif %};">
    <p style="margin: 0; font-weight: bold;">
      üí∞ –°—É–º–º–∞ –ø—Ä–∏–±—ã–ª–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥: 
      <span style="color: {% if total_profit >= 0 %}#155724{% else %}#721c24{% endif %};">
        {{ total_profit|floatformat:2 }} ‚ÇΩ
      </span>
    </p>
    {% if dates|length > 0 %}
    <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #666;">
      –°—Ä–µ–¥–Ω—è—è –ø—Ä–∏–±—ã–ª—å –≤ –¥–µ–Ω—å: {{ avg_profit_per_day|floatformat:2 }} ‚ÇΩ
    </p>
    {% endif %}
  </div>
  {% endif %}
  
  <p><strong>–ú–µ–¥–∏–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</strong> {{ median_value|floatformat:1 }}</p>
  <p><strong>–î–∞—Ç—ã:</strong> {{ dates|safe }}</p>
  <p><strong>–î–∞–Ω–Ω—ã–µ:</strong> {{ data|safe }}</p>
</div>

<!-- –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞ -->
<div style="margin-bottom: 20px">
  <!-- –ü–µ—Ä–≤—ã–π —Ä—è–¥ –∫–Ω–æ–ø–æ–∫ -->
  <div style="margin-bottom: 10px">
    <a
      href="{% url 'forms_app:form4_chart' code=code %}"
      class="btn {% if chart_type == 'profit' %}active{% endif %}"
      >üìà –ü—Ä–∏–±—ã–ª—å</a
    >
    <a
      href="{% url 'forms_app:form4_chart_type' code=code chart_type='sales' %}"
      class="btn {% if chart_type == 'sales' %}active{% endif %}"
      >üí∞ –ü—Ä–æ–¥–∞–∂–∏</a
    >
    <a
      href="{% url 'forms_app:form4_chart_type' code=code chart_type='orders' %}"
      class="btn {% if chart_type == 'orders' %}active{% endif %}"
      >üì¶ –ó–∞–∫–∞–∑—ã</a
    >
    <a
      href="{% url 'forms_app:form4_chart_type' code=code chart_type='percent' %}"
      class="btn {% if chart_type == 'percent' %}active{% endif %}"
      >% –í—ã–∫—É–ø–∞</a
    >
    <a
      href="{% url 'forms_app:form4_chart_type' code=code chart_type='price' %}"
      class="btn {% if chart_type == 'price' %}active{% endif %}"
      >üè∑Ô∏è –¶–µ–Ω–∞ –ù–∞—à–∞ –°—Ä–µ–¥–Ω—è—è</a
    >
  </div>
  
  <!-- –í—Ç–æ—Ä–æ–π —Ä—è–¥ –∫–Ω–æ–ø–æ–∫ -->
  <div style="margin-top: 10px">
    <a
      href="{% url 'forms_app:form4_chart_type' code=code chart_type='log_price_percent' %}"
      class="btn {% if chart_type == 'log_price_percent' %}active{% endif %}"
      >üöö% –õ–æ–≥/–¶–µ–Ω–∞</a
    >
    <a
      href="{% url 'forms_app:form4_chart_type' code=code chart_type='qentity_sale' %}"
      class="btn {% if chart_type == 'qentity_sale' %}active{% endif %}"
      >üìä –ß–∏—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —à—Ç</a
    >
    <a
      href="{% url 'forms_app:form4_chart_type' code=code chart_type='spp_percent' %}"
      class="btn {% if chart_type == 'spp_percent' %}active{% endif %}"
      >üìä % –°–ü–ü</a
    >
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const ctx = document.getElementById('chartCanvas').getContext('2d');
      const labels = {{ dates|safe }};
      const chartData = {{ data|safe }};
      const chartType = '{{ chart_type }}';

      console.log('Labels:', labels);
      console.log('Data:', chartData);
      console.log('Chart type:', chartType);

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏ –æ—Å–∏ Y
      function getYAxisTitle(chartType) {
          switch(chartType) {
              case 'percent':
              case 'log_price_percent':
              case 'spp_percent':
                  return '%';
              case 'orders':
              case 'qentity_sale':
                  return '—à—Ç';
              case 'profit':
              case 'sales':
              case 'price':
              default:
                  return '—Ä—É–±';
          }
      }

      // –°–æ–∑–¥–∞—ë–º –≥—Ä–∞—Ñ–∏–∫
      new Chart(ctx, {
          type: 'line',
          data: {
              labels: labels,
              datasets: [{
                  label: '{{ label }}',
                  data: chartData,
                  borderColor: '{{ color }}',
                  backgroundColor: '{{ color }}'.replace(')', ', 0.1)'),
                  borderWidth: 2,
                  tension: 0,
                  fill: true
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'top',
                  },
                  tooltip: {
                      mode: 'index',
                      intersect: false
                  }
              },
              scales: {
                  y: {
                      beginAtZero: false,
                      ticks: {
                          callback: function(value) {
                              if (chartType === 'percent' || chartType === 'log_price_percent' || chartType === 'spp_percent') {
                                  return value + '%';
                              } else if (chartType === 'orders' || chartType === 'qentity_sale') {
                                  return value;
                              } else {
                                  return value.toLocaleString() + ' ‚ÇΩ';
                              }
                          }
                      },
                      title: {
                          display: true,
                          text: getYAxisTitle(chartType)
                      }
                  }
              }
          }
      });
  });
</script>

<!-- ‚úÖ –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞—Ç -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const today = new Date().toISOString().split("T")[0];
    const prev30 = new Date();
    prev30.setDate(prev30.getDate() - 30);
    const prev30Str = prev30.toISOString().split("T")[0];

    const start = document.getElementById("start_date");
    const end = document.getElementById("end_date");

    if (!start.value) start.value = prev30Str;
    if (!end.value) end.value = today;
  });
</script>

<div style="margin-top: 30px">
  <a href="{% url 'forms_app:form4_detail' code=code %}" class="btn"
    >‚Üê –ù–∞–∑–∞–¥ –∫ –¥–∞–Ω–Ω—ã–º</a
  >
  <a href="{% url 'forms_app:form4_list' %}" class="btn">üìã –í—Å–µ –∞—Ä—Ç–∏–∫—É–ª—ã</a>
</div>
{% else %}
<p style="color: #888; font-style: italic">
  üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞.
</p>
<a href="{% url 'forms_app:form4_detail' code=code %}" class="btn">‚Üê –ù–∞–∑–∞–¥</a>
{% endif %} {% endblock %}