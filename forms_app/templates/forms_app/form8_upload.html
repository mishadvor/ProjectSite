<!-- templates/forms_app/form8_upload.html -->
{% extends "base.html" %} {% load static %} {% block title %}–§–æ—Ä–º–∞ 8 ‚Äî –ü—Ä–∏–±—ã–ª—å
–ø–æ –Ω–µ–¥–µ–ª—è–º{% endblock %} {% block extra_head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .chart-container {
    position: relative;
    height: 400px;
    width: 100%;
    margin-bottom: 30px;
  }
</style>
{% endblock %} {% block content %}
<h2>üìä –§–æ—Ä–º–∞ 8. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º</h2>
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h3>–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel-—Ñ–∞–π–ª—ã:</h3>
  </div>

  <div class="card-body">
    <form
      method="post"
      enctype="multipart/form-data"
      class="needs-validation"
      novalidate
    >
      {% csrf_token %}

      <!-- –ü–æ–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ -->
      <div class="mb-4">
        <!-- –£–≤–µ–ª–∏—á–∏–ª margin-bottom —Å 3 –¥–æ 4 -->
        <label
          for="{{ form.files.id_for_label }}"
          class="form-label d-block mb-2"
        >
          <!-- –î–æ–±–∞–≤–∏–ª d-block –∏ mb-2 -->
          {{ form.files.label }}
        </label>
        <div class="input-group">
          <!-- –î–æ–±–∞–≤–∏–ª input-group –¥–ª—è –ª—É—á—à–µ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è -->
          {{ form.files }}
        </div>
      </div>

      <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ -->
      <div class="mb-4">
        <!-- –£–≤–µ–ª–∏—á–∏–ª margin-bottom -->
        <small class="text-muted">
          –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è .xlsx. –í –∏–º–µ–Ω–∞—Ö —Ñ–∞–π–ª–æ–≤ –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å –¥–∞—Ç—É:
          <code>25.04.2025.xlsx</code>
        </small>
      </div>
      <br />
      <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
      <div class="d-grid gap-2">
        <!-- –î–æ–±–∞–≤–∏–ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–∫–∏ -->
        <button type="submit" class="btn btn-primary py-2">
          <!-- –î–æ–±–∞–≤–∏–ª padding –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ -->
          <i class="fas fa-upload me-2"></i>
          <!-- –î–æ–±–∞–≤–∏–ª –æ—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ –æ—Ç –∏–∫–æ–Ω–∫–∏ -->
          –ó–∞–≥—Ä—É–∑–∏—Ç—å
        </button>
      </div>
    </form>
  </div>
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
{% if messages %}
<div class="alert alert-info">
  {% for message in messages %}
  <div>{{ message }}</div>
  {% endfor %}
</div>
{% endif %}

<!-- –û—à–∏–±–∫–∏ —Ñ–æ—Ä–º—ã -->
{% if form.errors %}
<div class="alert alert-danger">
  <strong>–û—à–∏–±–∫–∏ —Ñ–æ—Ä–º—ã:</strong>
  <ul>
    {% for field, errors in form.errors.items %} {% for error in errors %}
    <li><strong>{{ field }}</strong>: {{ error }}</li>
    {% endfor %} {% endfor %}
  </ul>
</div>
{% endif %}

<!-- –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö -->
{% if reports %}
<div class="card mb-5">
  <div class="card-header bg-success text-white">
    <h2>üìã –î–∞–Ω–Ω—ã–µ –ø–æ –Ω–µ–¥–µ–ª—è–º</h2>
  </div>
  <div class="card-body">
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π –∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —à–∞–ø–∫–æ–π -->
    <div style="max-height: 400px; overflow-y: auto; overflow-x: auto">
      <table class="table table-striped table-hover table-sm mb-0">
        <thead
          class="table-light"
          style="
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
          "
        >
          <tr>
            <th>–ù–µ–¥–µ–ª—è</th>
            <th>–ü—Ä–∏–±—ã–ª—å</th>
            <th>–ß–∏—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∂–∏</th>
            <th>–ó–∞–∫–∞–∑—ã</th>
            <th>% –°–ü–ü</th>
            <th>–°—Ä. —Ü–µ–Ω–∞</th>
            <th>–ü—Ä–∏–±—ã–ª—å –Ω–∞ —é–±–∫—É</th>
            <th>% –í—ã–∫—É–ø–∞</th>
          </tr>
        </thead>
        <tbody>
          {% for r in reports %}
          <tr>
            <td>{{ r.week_name }}</td>
            <td>{{ r.profit|floatformat:0 }} ‚ÇΩ</td>
            <td>{{ r.clean_sales_ours|floatformat:0 }} ‚ÇΩ</td>
            <td>{{ r.orders }} —à—Ç</td>
            <td>{{ r.spp_percent|floatformat:1 }}%</td>
            <td>{{ r.avg_price|floatformat:0 }} ‚ÇΩ</td>
            <td>{{ r.profit_per_skirt|floatformat:0 }} ‚ÇΩ</td>
            <td>{{ r.pickup_rate|floatformat:1 }}%</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

<!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
{% if chart_data.labels %}
<h2 class="mb-4 text-center text-primary">üìà –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</h2>

<div class="chart-container">
  <canvas id="profitChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="salesChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="sppChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="priceChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="profitPerSkirtChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="ordersChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="pickupChart"></canvas>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è canvas-—ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const chartIds = [
      'profitChart', 'salesChart', 'sppChart', 'priceChart',
      'profitPerSkirtChart', 'ordersChart', 'pickupChart'
    ];

    chartIds.forEach(id => {
      if (!document.getElementById(id)) {
        console.error(`–≠–ª–µ–º–µ–Ω—Ç ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM`);
        return;
      }
    });

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const labels = {{ chart_data.labels|safe }};
    const profitData = {{ chart_data.profit|safe }};
    const salesData = {{ chart_data.sales|safe }};
    const sppData = {{ chart_data.spp|safe }};
    const priceData = {{ chart_data.price|safe }};
    const profitPerSkirtData = {{ chart_data.profit_per_skirt|safe }};
    const ordersData = {{ chart_data.orders|safe }};
    const pickupData = {{ chart_data.pickup|safe }};

    console.log("–î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤:", {
      labels, profitData, salesData, sppData,
      priceData, profitPerSkirtData, ordersData, pickupData
    });

    // –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    const chartOptions = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: ctx => ctx.parsed.y.toLocaleString()
          }
        }
      },
      scales: {
        y: { beginAtZero: true }
      }
    };

    // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
    try {
      // –ì—Ä–∞—Ñ–∏–∫ 1: –ü—Ä–∏–±—ã–ª—å
      new Chart(document.getElementById('profitChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '–ü—Ä–∏–±—ã–ª—å (—Ä—É–±.)',
            data: profitData,
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            fill: true,
            tension: 0
          }]
        },
        options: {
          ...chartOptions,
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: '–†—É–±–ª–∏' }
            }
          }
        }
      });

      // –ì—Ä–∞—Ñ–∏–∫ 2: –ß–∏—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∂–∏
      new Chart(document.getElementById('salesChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '–ß–∏—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∂–∏ (—Ä—É–±.)',
            data: salesData,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            fill: true,
            tension: 0
          }]
        },
        options: chartOptions
      });

      // –ì—Ä–∞—Ñ–∏–∫ 3: % –°–ü–ü
      new Chart(document.getElementById('sppChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '% –°–ü–ü',
            data: sppData,
            borderColor: 'rgb(255, 159, 64)',
            backgroundColor: 'rgba(255, 159, 64, 0.1)',
            fill: true,
            tension: 0
          }]
        },
        options: {
          ...chartOptions,
          scales: {
            y: {
              min: 0,
              max: 50,
              title: { display: true, text: '%' }
            }
          }
        }
      });

      // –ì—Ä–∞—Ñ–∏–∫ 4: –ù–∞—à–∞ —Ü–µ–Ω–∞
      new Chart(document.getElementById('priceChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ (—Ä—É–±.)',
            data: priceData,
            borderColor: 'rgb(153, 102, 255)',
            backgroundColor: 'rgba(153, 102, 255, 0.1)',
            fill: true,
            tension: 0
          }]
        },
        options: chartOptions
      });

      // –ì—Ä–∞—Ñ–∏–∫ 5: –ü—Ä–∏–±—ã–ª—å –Ω–∞ —é–±–∫—É
      new Chart(document.getElementById('profitPerSkirtChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '–ü—Ä–∏–±—ã–ª—å –Ω–∞ 1 —é–±–∫—É (—Ä—É–±.)',
            data: profitPerSkirtData,
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            fill: true,
            tension: 0
          }]
        },
        options: chartOptions
      });

      // –ì—Ä–∞—Ñ–∏–∫ 6: –ó–∞–∫–∞–∑—ã
      new Chart(document.getElementById('ordersChart'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '–ó–∞–∫–∞–∑—ã (—à—Ç.)',
            data: ordersData,
            backgroundColor: 'rgba(54, 162, 235, 0.6)'
          }]
        },
        options: {
          ...chartOptions,
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: '–®—Ç—É–∫–∏' }
            }
          }
        }
      });

      // –ì—Ä–∞—Ñ–∏–∫ 7: % –í—ã–∫—É–ø–∞
      new Chart(document.getElementById('pickupChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '% –í—ã–∫—É–ø–∞',
            data: pickupData,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            fill: true,
            tension: 0
          }]
        },
        options: {
          ...chartOptions,
          scales: {
            y: {
              min: 0,
              max: 60,
              title: { display: true, text: '%' }
            }
          }
        }
      });

      console.log("–í—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã");
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤:", error);
    }
  });
</script>

{% else %}
<div class="alert alert-info">
  <i class="fas fa-info-circle"></i> –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤.
  –ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel-—Ñ–∞–π–ª—ã.
</div>
{% endif %}

<!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
<div class="mt-4 text-center">
  <form
    method="post"
    action="{% url 'forms_app:form8_clear' %}"
    style="display: inline"
  >
    {% csrf_token %}
    <button
      type="submit"
      class="btn btn-danger btn-sm"
      onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã 8?')"
    >
      <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    </button>
  </form>
  <a href="{% url 'forms_app:form8_export' %}" class="btn btn-success btn-sm">
    <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
  </a>
</div>

{% endblock %}
