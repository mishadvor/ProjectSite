<!-- templates/forms_app/form12_chart.html -->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">üìà –ì—Ä–∞—Ñ–∏–∫: {{ label }} - WB: {{ wb_article }} {% if seller_article and seller_article != "‚Äî" %}({{ seller_article }}){% endif %}</h2>
        <div>
            <!-- –î–û–ë–ê–í–õ–ï–ù–ê –ö–ù–û–ü–ö–ê –ü–ï–†–ï–•–û–î–ê –ö –°–ü–ò–°–ö–£ –ê–†–¢–ò–ö–£–õ–û–í -->
            <a href="{% url 'forms_app:form12_list' %}" class="btn btn-outline-info me-2">
                üìã –°–ø–∏—Å–æ–∫ –∞—Ä—Ç–∏–∫—É–ª–æ–≤
            </a>
            <a href="{% url 'forms_app:form12_detail' wb_article %}" class="btn btn-secondary">
                ‚Üê –ù–∞–∑–∞–¥ –∫ –¥–µ—Ç–∞–ª—è–º
            </a>
        </div>
    </div>
    
   
    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º - –ö–ê–ö –í –§–û–†–ú–ï 8 -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0">üìÖ –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º</h4>
        </div>
        <div class="card-body">
            <form method="GET" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <label for="start_date" style="margin-right: 15px;">
                    <strong>–ù–∞—á–∞–ª–æ:</strong>
                    <input type="date" id="start_date" name="start_date" value="{{ start_date }}" 
                        style="padding: 6px; border: 1px solid #ccc; border-radius: 4px" />
                </label>

                <label for="end_date" style="margin-right: 15px;">
                    <strong>–ö–æ–Ω–µ—Ü:</strong>
                    <input type="date" id="end_date" name="end_date" value="{{ end_date }}" 
                        style="padding: 6px; border: 1px solid #ccc; border-radius: 4px" />
                </label>

                <button type="submit" 
                        style="padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                    üìÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>

                <a href="{% url 'forms_app:form12_chart' wb_article chart_type %}" 
                style="color: #666; font-size: 0.9em">
                    –°–±—Ä–æ—Å–∏—Ç—å
                </a>
            </form>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ - –£–í–ï–õ–ò–ß–ï–ù–ù–´–ô -->
    <div class="card mb-4">
        
        <div class="card-body p-3">  <!-- –£–º–µ–Ω—å—à–∏–ª–∏ padding –¥–ª—è –±–æ–ª—å—à–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ -->
            <div class="chart-container">
                <canvas id="myChart" width="1200" height="600"></canvas>
            </div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ - –í –û–î–ù–£ –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–£–Æ –õ–ò–ù–ò–Æ -->
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤</h4>
        </div>
        <div class="card-body">
            <div class="d-flex flex-row gap-2 justify-content-between">
                <a href="{% url 'forms_app:form12_chart' wb_article 'orders' %}" 
                   class="btn {% if chart_type == 'orders' %}btn-primary{% else %}btn-outline-primary{% endif %} flex-fill fs-6">
                    üìà –ì—Ä–∞—Ñ–∏–∫ –∑–∞–∫–∞–∑–æ–≤
                </a>
                <a href="{% url 'forms_app:form12_chart' wb_article 'sold' %}" 
                   class="btn {% if chart_type == 'sold' %}btn-success{% else %}btn-outline-success{% endif %} flex-fill fs-6">
                    üí∞ –ì—Ä–∞—Ñ–∏–∫ –≤—ã–∫—É–ø–æ–≤
                </a>
                <a href="{% url 'forms_app:form12_chart' wb_article 'transfer' %}" 
                   class="btn {% if chart_type == 'transfer' %}btn-warning{% else %}btn-outline-warning{% endif %} flex-fill fs-6">
                    üí≥ –ì—Ä–∞—Ñ–∏–∫ –∫ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é
                </a>
                <a href="{% url 'forms_app:form12_chart' wb_article 'stock' %}" 
                   class="btn {% if chart_type == 'stock' %}btn-info{% else %}btn-outline-info{% endif %} flex-fill fs-6">
                    üì¶ –ì—Ä–∞—Ñ–∏–∫ –æ—Å—Ç–∞—Ç–∫–æ–≤
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('myChart').getContext('2d');
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞
    const data = {{ data|safe }};
    const chartType = '{{ chart_type }}';
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≥—Ä–∞–Ω–∏—Ü –æ—Å–∏ Y
    function calculateYBounds(chartData, type) {
        if (type !== 'stock') {
            return { beginAtZero: true };
        }
        
        // –î–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –º–∞—Å—à—Ç–∞–±
        const validData = chartData.filter(value => value !== null && value !== undefined);
        if (validData.length === 0) {
            return { beginAtZero: true };
        }
        
        const minValue = Math.min(...validData);
        const maxValue = Math.max(...validData);
        const range = maxValue - minValue;
        
        // –ï—Å–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω –º–∞–ª–µ–Ω—å–∫–∏–π, –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã
        if (range < 10) {
            const padding = Math.max(2, range * 0.2); // 20% –æ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω–∞, –Ω–æ –Ω–µ –º–µ–Ω–µ–µ 2
            return {
                beginAtZero: false,
                min: Math.max(0, minValue - padding), // –ù–µ –æ–ø—É—Å–∫–∞–µ–º—Å—è –Ω–∏–∂–µ 0
                max: maxValue + padding,
                ticks: {
                    precision: 0
                }
            };
        }
        
        // –î–ª—è –±–æ–ª—å—à–∏—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
        return {
            beginAtZero: false,
            suggestedMin: Math.max(0, minValue - (range * 0.1)), // 10% –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É
            suggestedMax: maxValue + (range * 0.1), // 10% –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É
            ticks: {
                precision: 0
            }
        };
    }
    
    const yBounds = calculateYBounds(data, chartType);

    const myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ dates|safe }},
            datasets: [{
                label: '{{ label }}',
                data: data,
                borderColor: '{{ color }}',
                backgroundColor: '{{ color }}22',
                borderWidth: 3,
                tension: 0, // –ü—Ä—è–º—ã–µ –ª–∏–Ω–∏–∏ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
                fill: false,
                pointBackgroundColor: '{{ color }}',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 8,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '{{ wb_article }} - {{ label }}',
                    font: {
                        size: 18
                    }
                },
                legend: {
                    display: true,
                    labels: {
                        font: {
                            size: 14
                        }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    bodyFont: {
                        size: 14
                    },
                    titleFont: {
                        size: 14
                    },
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('ru-RU').format(context.parsed.y);
                                if (chartType === 'stock' || chartType === 'orders' || chartType === 'sold') {
                                    label += ' —à—Ç';
                                } else if (chartType === 'transfer') {
                                    label += ' —Ä—É–±';
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '–î–∞—Ç–∞',
                        font: {
                            size: 14
                        }
                    },
                    ticks: {
                        font: {
                            size: 12
                        }
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: '{{ label }}',
                        font: {
                            size: 14
                        }
                    },
                    ...yBounds, // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Å—à—Ç–∞–±–∞
                    ticks: {
                        font: {
                            size: 12
                        },
                        callback: function(value) {
                            return new Intl.NumberFormat('ru-RU').format(value);
                        }
                    }
                }
            },
            elements: {
                line: {
                    tension: 0 // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä—è–º—ã–µ –ª–∏–Ω–∏–∏
                }
            }
        }
    });
</script>

<style>
.chart-container {
    position: relative;
    height: 600px;  /* –£–≤–µ–ª–∏—á–∏–ª–∏ —Å 400px –¥–æ 600px */
    width: 100%;
    margin: 0 auto;
}

/* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —à—Ä–∏—Ñ—Ç—ã –≤ –≥—Ä–∞—Ñ–∏–∫–µ */
.card-header h4 {
    font-weight: 600;
    font-size: 1.4rem;  /* –£–≤–µ–ª–∏—á–∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
}
.fs-5 {
    font-size: 1.2rem !important;  /* –£–≤–µ–ª–∏—á–∏–ª–∏ –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é */
}

/* –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤—É—é —à–∏—Ä–∏–Ω—É –∫–Ω–æ–ø–æ–∫ */
.flex-fill {
    flex: 1 1 0px;
    min-width: 0;
}
/* –ù–µ–±–æ–ª—å—à–∏–µ –æ—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ */
.gap-2 {
    gap: 0.5rem;
}
.gap-3 {
    gap: 1rem;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
@media (max-width: 768px) {
    .chart-container {
        height: 400px;  /* –ú–µ–Ω—å—à–∞—è –≤—ã—Å–æ—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    }
    .card-body.p-3 {
        padding: 1rem !important;
    }
}
</style>
{% endblock %}