# forms_app/views/form2_view.py
import pandas as pd
import numpy as np
from django.http import HttpResponse
from django.shortcuts import render
from io import BytesIO
from openpyxl import load_workbook  # –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç
from openpyxl.styles import (
    Alignment,
    Font,
    Border,
    Side,
    PatternFill,
)  # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏
from openpyxl.utils import get_column_letter  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏
from openpyxl.worksheet.dimensions import (
    ColumnDimension,
)  # –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —à–∏—Ä–∏–Ω–æ–π –∫–æ–ª–æ–Ω–æ–∫
from openpyxl.styles import NamedStyle, Alignment, Font, Border, Side


def safe_convert_to_int(value):
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Ü–µ–ª—ã–µ —á–∏—Å–ª–∞"""
    try:
        if isinstance(value, (pd.Series, pd.DataFrame)):
            return pd.to_numeric(value, errors="coerce").fillna(0).astype(int)
        return int(float(value))
    except (ValueError, TypeError):
        return 0


def safe_convert_to_float(value):
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —á–∏—Å–ª–∞ —Å –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–æ–π"""
    try:
        if isinstance(value, (pd.Series, pd.DataFrame)):
            return pd.to_numeric(value, errors="coerce").fillna(0.0)
        return float(value)
    except (ValueError, TypeError):
        return 0.0


def safe_mean_calculation(x, decimals=1):
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è"""
    try:
        filtered = x[x != 0]
        if len(filtered) > 0:
            return round(float(filtered.mean()), decimals)
        return 0.0
    except Exception:
        return 0.0


def form2(request):
    if request.method == "POST":
        mode = request.POST.get("mode")
        # –ü–æ–ª—É—á–∞–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ —Ñ–æ—Ä–º—ã
        try:
            sebestoimost = float(request.POST.get("sebestoimost", 600))
        except (ValueError, TypeError):
            sebestoimost = 600.0
        try:
            # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
            if mode == "single":
                file = request.FILES.get("file_single")
                if not file:
                    return render(
                        request,
                        "forms_app/form2.html",
                        {"error": "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª."},
                    )

                df = pd.read_excel(file)
            elif mode == "combined":
                file_russia = request.FILES.get("file_russia")
                file_cis = request.FILES.get("file_cis")
                if not file_russia or not file_cis:
                    return render(
                        request,
                        "forms_app/form2.html",
                        {"error": "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–∞ —Ñ–∞–π–ª–∞."},
                    )

                df_russia = pd.read_excel(file_russia)
                df_cis = pd.read_excel(file_cis)
                df = pd.concat([df_russia, df_cis], ignore_index=True)
            else:
                return render(
                    request, "forms_app/form2.html", {"error": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º."}
                )

            # –°–ø–∏—Å–æ–∫ —á–∏—Å–ª–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            numeric_cols = [
                "–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è",
                "–í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –¢–æ–≤–∞—Ä (–ü—Ä)",
                "–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¢–æ–≤–∞—Ä",
                "–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é",
            ]

            # –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–∏—Å–ª–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
            for col in numeric_cols:
                if col in df.columns:
                    df[col] = df[col].apply(safe_convert_to_float)

            # –û—Å–Ω–æ–≤–Ω–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –∫–æ–¥—É –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã
            sums1_per_category = (
                df.groupby("–ö–æ–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã")
                .agg(
                    {
                        "–ê—Ä—Ç–∏–∫—É–ª –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞": "first",
                        "–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è": "sum",
                        "–í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –¢–æ–≤–∞—Ä (–ü—Ä)": "sum",
                        "–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¢–æ–≤–∞—Ä": "sum",
                        "–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é": "sum",
                    }
                )
                .reset_index()
                # –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ –≥–¥–µ –∫–æ–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã —Ä–∞–≤–µ–Ω 0
                .query("`–ö–æ–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã` != 0")
            )

            # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
            for col in numeric_cols:
                sums1_per_category[col] = sums1_per_category[col].apply(
                    safe_convert_to_int
                )

            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã
            sums1_per_category["–ö –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –±–µ–∑ –õ–æ–≥–∏—Å—Ç–∏–∫–∏"] = (
                sums1_per_category["–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¢–æ–≤–∞—Ä"]
                - sums1_per_category["–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é"]
            ).apply(safe_convert_to_int)

            sums1_per_category["–°—É–º–º–∞ –°–ü–ü"] = (
                sums1_per_category["–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è"]
                - sums1_per_category["–í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –¢–æ–≤–∞—Ä (–ü—Ä)"]
            ).apply(safe_convert_to_int)

            # –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –¥–µ–ª–µ–Ω–∏—è –Ω–∞ 0
            sums1_per_category["% –õ–æ–≥/—Ä—Å"] = (
                np.where(
                    sums1_per_category["–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¢–æ–≤–∞—Ä"]
                    == 0,
                    0,
                    (
                        sums1_per_category["–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é"]
                        / sums1_per_category[
                            "–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¢–æ–≤–∞—Ä"
                        ]
                    )
                    * 100,
                )
            ).round(1)

            sums1_per_category["% –õ–æ–≥/–ù–∞—à–∞ –¶–µ–Ω–∞"] = (
                np.where(
                    sums1_per_category["–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è"] == 0,
                    0,
                    (
                        sums1_per_category["–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é"]
                        / sums1_per_category["–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è"]
                    )
                    * 100,
                )
            ).round(1)

            # –ê–≥—Ä–µ–≥–∞—Ü–∏—è –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –ø–æ –∫–æ–¥—É –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã
            returns_by_code = (
                df[df["–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞"] == "–í–æ–∑–≤—Ä–∞—Ç"]
                .groupby("–ö–æ–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã")
                .agg(
                    {
                        "–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è": "sum",
                        "–í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –¢–æ–≤–∞—Ä (–ü—Ä)": "sum",
                        "–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¢–æ–≤–∞—Ä": "sum",
                    }
                )
                .reset_index()
                .rename(
                    columns={
                        "–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è": "–í–æ–∑–≤—Ä–∞—Ç—ã –ù–∞—à–∞ —Ü–µ–Ω–∞",
                        "–í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –¢–æ–≤–∞—Ä (–ü—Ä)": "–í–æ–∑–≤—Ä–∞—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –í–ë",
                        "–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¢–æ–≤–∞—Ä": "–í–æ–∑–≤—Ä–∞—Ç—ã –∫ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é",
                    }
                )
            )

            # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
            for col in [
                "–í–æ–∑–≤—Ä–∞—Ç—ã –ù–∞—à–∞ —Ü–µ–Ω–∞",
                "–í–æ–∑–≤—Ä–∞—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –í–ë",
                "–í–æ–∑–≤—Ä–∞—Ç—ã –∫ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é",
            ]:
                returns_by_code[col] = returns_by_code[col].apply(safe_convert_to_int)

            # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            first_merged = sums1_per_category.merge(
                returns_by_code, on="–ö–æ–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã", how="left"
            ).fillna(0)

            # –†–∞—Å—á–µ—Ç —á–∏—Å—Ç—ã—Ö –ø—Ä–æ–¥–∞–∂
            first_merged["–ß–∏—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∂–∏ –ù–∞—à–∏"] = (
                first_merged["–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è"] - first_merged["–í–æ–∑–≤—Ä–∞—Ç—ã –ù–∞—à–∞ —Ü–µ–Ω–∞"]
            ).apply(safe_convert_to_int)

            first_merged["–ß–∏—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –í–ë"] = (
                first_merged["–í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –¢–æ–≤–∞—Ä (–ü—Ä)"]
                - first_merged["–í–æ–∑–≤—Ä–∞—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –í–ë"]
            ).apply(safe_convert_to_int)

            first_merged["–ß–∏—Å—Ç–æ–µ –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ"] = (
                first_merged["–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¢–æ–≤–∞—Ä"]
                - first_merged["–í–æ–∑–≤—Ä–∞—Ç—ã –∫ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é"]
            ).apply(safe_convert_to_int)

            first_merged["–ß–∏—Å—Ç–æ–µ –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –±–µ–∑ –õ–æ–≥–∏—Å—Ç–∏–∫–∏"] = (
                first_merged["–ß–∏—Å—Ç–æ–µ –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ"]
                - first_merged["–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é"]
            ).apply(safe_convert_to_int)

            # –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ –∫–æ–¥—É –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã
            # =====================================================
            cost_per_category = (
                df.groupby("–ö–æ–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã")
                .agg(
                    {
                        "–ê—Ä—Ç–∏–∫—É–ª –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞": "first",
                        "–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è": safe_mean_calculation,
                        "–í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –¢–æ–≤–∞—Ä (–ü—Ä)": safe_mean_calculation,
                        "–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¢–æ–≤–∞—Ä": safe_mean_calculation,
                        "–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é": lambda x: round(
                            safe_convert_to_float(x.mean() * 2), 1
                        ),
                    }
                )
                .reset_index()
            )

            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã –¥–ª—è —Å—Ä–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
            cost_per_category["–°–ü–ü –°—Ä–µ–¥–Ω—è—è"] = (
                cost_per_category["–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è"]
                - cost_per_category["–í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –¢–æ–≤–∞—Ä (–ü—Ä)"]
            ).round(1)

            cost_per_category["–ö –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –±–µ–∑ –õ–æ–≥–∏—Å—Ç–∏–∫–∏ –°—Ä–µ–¥–Ω—è—è"] = (
                cost_per_category["–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¢–æ–≤–∞—Ä"]
                - cost_per_category["–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é"]
            ).round(1)

            cost_per_category["% –õ–æ–≥/–ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ —Å –õ–æ–≥ –°—Ä–µ–¥–Ω–∏–π"] = (
                np.where(
                    cost_per_category["–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¢–æ–≤–∞—Ä"]
                    == 0,
                    0,
                    (
                        cost_per_category["–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é"]
                        / cost_per_category[
                            "–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¢–æ–≤–∞—Ä"
                        ]
                    )
                    * 100,
                )
            ).round(1)

            cost_per_category["% –õ–æ–≥/–ù–∞—à–∞ —Ü–µ–Ω–∞ –°—Ä–µ–¥–Ω–∏–π"] = (
                np.where(
                    cost_per_category["–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è"] == 0,
                    0,
                    (
                        cost_per_category["–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é"]
                        / cost_per_category["–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è"]
                    )
                    * 100,
                )
            ).round(1)

            # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–æ —Å—Ä–µ–¥–Ω–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            second_merged = first_merged.merge(
                cost_per_category,
                on="–ö–æ–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã",
                how="left",
                suffixes=("", "_–°—Ä–µ–¥–Ω–µ–µ"),
            ).fillna(0)

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–≥–∏—Å—Ç–∏–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –∫–æ–ª–æ–Ω–∫–∞)
            log_col = next((col for col in df.columns if "–í–∏–¥—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏" in col), None)
            if log_col:
                df_exploded = df.explode(log_col)
                df_exploded[log_col] = df_exploded[log_col].fillna("–ù–µ —É–∫–∞–∑–∞–Ω–æ")

                status_log = (
                    df_exploded.groupby("–ö–æ–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã")
                    .agg(
                        {
                            log_col: lambda x: x.value_counts().to_dict(),
                            "–ê—Ä—Ç–∏–∫—É–ª –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞": "first",
                        }
                    )
                    .reset_index()
                )

                # –†–∞—Å–∫—Ä—ã–≤–∞–µ–º —Å–ª–æ–≤–∞—Ä—å –≤ –∫–æ–ª–æ–Ω–∫–∏
                status_log = pd.concat(
                    [
                        status_log.drop(log_col, axis=1),
                        status_log[log_col].apply(pd.Series).fillna(0),
                    ],
                    axis=1,
                )

                # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ —á–∏—Å–ª–æ–≤—ã–µ
                required_events = [
                    "–ö –∫–ª–∏–µ–Ω—Ç—É –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ",
                    "–û—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ",
                    "–û—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ",
                ]
                for event in required_events:
                    if event not in status_log.columns:
                        status_log[event] = 0
                    # –ü—Ä–∏–≤–æ–¥–∏–º –∫ —á–∏—Å–ª—É (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å —Å—Ç—Ä–æ–∫–∏)
                    status_log[event] = (
                        pd.to_numeric(status_log[event], errors="coerce")
                        .fillna(0)
                        .astype(float)
                    )

                # –†–∞—Å—á—ë—Ç —á–∏—Å–ª–∏—Ç–µ–ª—è –∏ –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—è
                numerator = status_log["–ö –∫–ª–∏–µ–Ω—Ç—É –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ"]
                denominator = (
                    status_log["–ö –∫–ª–∏–µ–Ω—Ç—É –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ"]
                    + status_log["–û—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ"]
                    + status_log["–û—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ"]
                )

                # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–∞—Å—á—ë—Ç %–í—ã–∫—É–ø–∞ –±–µ–∑ .fillna() –Ω–∞ ndarray
                with np.errstate(divide="ignore", invalid="ignore"):
                    buyout_rate = np.where(
                        denominator == 0, 0.0, (numerator / denominator) * 100
                    )

                # –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 1 –∑–Ω–∞–∫–∞)
                status_log["%–í—ã–∫—É–ø–∞"] = np.round(buyout_rate.astype(float), 1)

                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã
                status_log["–°–µ–±–µ—Å –ü—Ä–æ–¥–∞–∂"] = (numerator * sebestoimost).round(0)
                status_log["–ß–∏—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —à—Ç"] = numerator
                status_log["–ó–∞–∫–∞–∑—ã"] = denominator

                # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏ –ª–æ–≥–∏—Å—Ç–∏–∫–∏
                third_merged = second_merged.merge(
                    status_log[
                        [
                            "–ö–æ–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã",
                            "%–í—ã–∫—É–ø–∞",
                            "–°–µ–±–µ—Å –ü—Ä–æ–¥–∞–∂",
                            "–ß–∏—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —à—Ç",
                            "–ó–∞–∫–∞–∑—ã",
                            "–û—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ",
                            "–û—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ",
                        ]
                    ],
                    on="–ö–æ–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã",
                    how="left",
                ).fillna(0)
            else:
                third_merged = second_merged

            # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤
            third_merged = third_merged.rename(
                columns={
                    "–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è": "–°—É–º–º–∞ –ü—Ä–æ–¥–∞–∂ –ù–∞—à–∞ –¶–µ–Ω–∞",
                    "–í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –¢–æ–≤–∞—Ä (–ü—Ä)": "–°—É–º–º–∞ –ü—Ä–æ–¥–∞–∂ –ø–æ —Ü–µ–Ω–µ –í–ë",
                    "–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¢–æ–≤–∞—Ä": "–°—É–º–º–∞ –ü—Ä–æ–¥–∞–∂ –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –° –õ–æ–≥",
                    "–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é": "–õ–æ–≥–∏—Å—Ç–∏–∫–∞",
                    "–û—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ": "–í–æ–∑–≤—Ä–∞—Ç—ã, —à—Ç",
                    "–û—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ": "–û—Ç–º–µ–Ω–∞",
                }
            )

            # –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã
            third_merged["–ú–∞—Ä–∂–∞"] = (
                third_merged["–ß–∏—Å—Ç–æ–µ –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –±–µ–∑ –õ–æ–≥–∏—Å—Ç–∏–∫–∏"]
                - third_merged["–°–µ–±–µ—Å –ü—Ä–æ–¥–∞–∂"]
            ).round(1)

            third_merged["–ù–∞–ª–æ–≥–∏"] = (
                third_merged["–ß–∏—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –í–ë"] * 0.07
            ).round(1)

            third_merged["–ü—Ä–∏–±—ã–ª—å"] = (
                third_merged["–ú–∞—Ä–∂–∞"] - third_merged["–ù–∞–ª–æ–≥–∏"]
            ).round(1)

            third_merged["–ü—Ä–∏–±—ã–ª—å –Ω–∞ 1 –Æ–±–∫—É"] = (
                (third_merged["–ü—Ä–∏–±—ã–ª—å"] / third_merged["–ß–∏—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —à—Ç"])
                .replace([np.inf, -np.inf], 0)  # –∑–∞–º–µ–Ω–∞ ¬±–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–µ–π
                .fillna(0)  # –µ—Å–ª–∏ –ø—Ä–∏–±—ã–ª—å –∏ –ø—Ä–æ–¥–∞–∂–∏ = 0 ‚Üí NaN ‚Üí –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ 0
                .round(1)
            )

            # –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–µ—Ä–µ–¥ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –ø–æ—Ä—è–¥–∫–∞
            third_merged["–ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é"] = ""  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
            third_merged["–ü–ª–∞–Ω –ø–æ –¥–æ—Ö–æ–¥—É"] = ""  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
            third_merged["–î–æ–ø —É–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–∞ –∫–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤ 1 –ê—Ä—Ç–∏–∫—É–ª–∞"] = ""
            third_merged["% –°–ü–ü"] = ""

            third_merged = third_merged.rename(
                columns={
                    "–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è": "–°—É–º–º–∞ –ü—Ä–æ–¥–∞–∂ –ù–∞—à–∞ –¶–µ–Ω–∞",
                    "–í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –¢–æ–≤–∞—Ä (–ü—Ä)": "–°—É–º–º–∞ –ü—Ä–æ–¥–∞–∂ –ø–æ —Ü–µ–Ω–µ –í–ë",
                    "–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¢–æ–≤–∞—Ä": "–°—É–º–º–∞ –ü—Ä–æ–¥–∞–∂ –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –° –õ–æ–≥",
                    "–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é": "–õ–æ–≥–∏—Å—Ç–∏–∫–∞",
                    "–û—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ": "–í–æ–∑–≤—Ä–∞—Ç—ã, —à—Ç",
                    "–û—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ": "–û—Ç–º–µ–Ω–∞",
                    "–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è_–°—Ä–µ–¥–Ω–µ–µ": "–ù–∞—à–∞ —Ü–µ–Ω–∞ –°—Ä–µ–¥–Ω—è—è",
                    "–í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –¢–æ–≤–∞—Ä (–ü—Ä)_–°—Ä–µ–¥–Ω–µ–µ": "–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –í–ë –°—Ä–µ–¥–Ω—è—è",
                    "–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¢–æ–≤–∞—Ä_–°—Ä–µ–¥–Ω–µ–µ": "–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –°—Ä–µ–¥–Ω–µ–µ",
                    "–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é_–°—Ä–µ–¥–Ω–µ–µ": "–õ–æ–≥–∏—Å—Ç–∏–∫–∞ –°—Ä–µ–¥–Ω—è—è",
                }
            )

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∂–µ–ª–∞–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –∫–æ–ª–æ–Ω–æ–∫
            desired_columns_order = [
                "–ö–æ–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã",
                "–ê—Ä—Ç–∏–∫—É–ª –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞",
                "–ß–∏—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∂–∏ –ù–∞—à–∏",
                "–ß–∏—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –í–ë",
                "–ß–∏—Å—Ç–æ–µ –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ",
                "–ß–∏—Å—Ç–æ–µ –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –±–µ–∑ –õ–æ–≥–∏—Å—Ç–∏–∫–∏",
                "–°–µ–±–µ—Å –ü—Ä–æ–¥–∞–∂",
                "–ü—Ä–∏–±—ã–ª—å",
                "–ù–∞—à–∞ —Ü–µ–Ω–∞ –°—Ä–µ–¥–Ω—è—è",  # –ù–∞—à–∞ —Ü–µ–Ω–∞ –°—Ä–µ–¥–Ω—è—è
                "–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –í–ë –°—Ä–µ–¥–Ω—è—è",
                "–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –°—Ä–µ–¥–Ω–µ–µ",
                "–ü—Ä–∏–±—ã–ª—å –Ω–∞ 1 –Æ–±–∫—É",
                "–ó–∞–∫–∞–∑—ã",
                "–ß–∏—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —à—Ç",
                "%–í—ã–∫—É–ø–∞",
                "–°–ü–ü –°—Ä–µ–¥–Ω—è—è",
                "% –°–ü–ü",
                "–ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é",
                "–ü–ª–∞–Ω –ø–æ –¥–æ—Ö–æ–¥—É",
                "–°—É–º–º–∞ –ü—Ä–æ–¥–∞–∂ –ù–∞—à–∞ –¶–µ–Ω–∞",
                "–°—É–º–º–∞ –ü—Ä–æ–¥–∞–∂ –ø–æ —Ü–µ–Ω–µ –í–ë",
                "–°—É–º–º–∞ –ü—Ä–æ–¥–∞–∂ –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –° –õ–æ–≥",
                "–õ–æ–≥–∏—Å—Ç–∏–∫–∞",
                "–ö –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –±–µ–∑ –õ–æ–≥–∏—Å—Ç–∏–∫–∏",
                "–°—É–º–º–∞ –°–ü–ü",
                "% –õ–æ–≥/—Ä—Å",
                "% –õ–æ–≥/–ù–∞—à–∞ –¶–µ–Ω–∞",
                "–í–æ–∑–≤—Ä–∞—Ç—ã –ù–∞—à–∞ —Ü–µ–Ω–∞",
                "–í–æ–∑–≤—Ä–∞—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –í–ë",
                "–í–æ–∑–≤—Ä–∞—Ç—ã –∫ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é",
                "–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é_–°—Ä–µ–¥–Ω–µ–µ",
                "–ö –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –±–µ–∑ –õ–æ–≥–∏—Å—Ç–∏–∫–∏ –°—Ä–µ–¥–Ω—è—è",
                "% –õ–æ–≥/–ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ —Å –õ–æ–≥ –°—Ä–µ–¥–Ω–∏–π",
                "% –õ–æ–≥/–ù–∞—à–∞ —Ü–µ–Ω–∞ –°—Ä–µ–¥–Ω–∏–π",
                "–í–æ–∑–≤—Ä–∞—Ç—ã, —à—Ç",
                "–û—Ç–º–µ–Ω–∞",
                "–ú–∞—Ä–∂–∞",
                "–ù–∞–ª–æ–≥–∏",
                "–î–æ–ø —É–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–∞ –∫–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤ 1 –ê—Ä—Ç–∏–∫—É–ª–∞",
            ]

            # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏
            existing_columns = [
                col for col in desired_columns_order if col in third_merged.columns
            ]
            third_merged = third_merged[existing_columns]

            # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ü—Ä–∏–±—ã–ª–∏
            third_merged.sort_values(by="–ü—Ä–∏–±—ã–ª—å", ascending=False, inplace=True)

            # === –ù–∞—á–∞–ª–æ: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ "–ß–∏—Å—Ç–æ–µ –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –±–µ–∑ –õ–æ–≥–∏—Å—Ç–∏–∫–∏" ===
            conditions = [
                third_merged["–ü—Ä–∏–±—ã–ª—å"] > 10000,
                (third_merged["–ü—Ä–∏–±—ã–ª—å"] >= 5000) & (third_merged["–ü—Ä–∏–±—ã–ª—å"] <= 10000),
                (third_merged["–ü—Ä–∏–±—ã–ª—å"] > 0) & (third_merged["–ü—Ä–∏–±—ã–ª—å"] < 5000),
                third_merged["–ü—Ä–∏–±—ã–ª—å"] < 0,
            ]

            categories_profit = [
                "1. >10 000",
                "2. 5 000 - 10 000",
                "3. 0 - 5 000",
                "4. <0 (—É–±—ã—Ç–∫–∏)",
            ]

            third_merged["–ì—Ä—É–ø–ø–∞ –ø–æ –ø—Ä–∏–±—ã–ª–∏"] = np.select(
                conditions, categories_profit, default="–ù–µ –ø–æ–ø–∞–ª"
            )
            # === –ö–æ–Ω–µ—Ü: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ "–ß–∏—Å—Ç–æ–µ –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –±–µ–∑ –õ–æ–≥–∏—Å—Ç–∏–∫–∏" ===

            # === –ù–∞—á–∞–ª–æ: –ö–æ–¥ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –ê—Ä—Ç–∏–∫—É–ª–æ–≤===
            def get_prefix(article):
                """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–µ—Ä–≤—ã—Ö —Ç—Ä—ë—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∞—Ä—Ç–∏–∫—É–ª–∞"""
                try:
                    return str(article).split("_")[0][:3]
                except:
                    return ""

            # –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º
            third_merged["–ü—Ä–µ—Ñ–∏–∫—Å"] = third_merged["–ê—Ä—Ç–∏–∫—É–ª –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞"].apply(
                get_prefix
            )

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–º –ø—Ä–µ—Ñ–∏–∫—Å—ã –∞—Ä—Ç–∏–∫—É–ª–∞
            categories = {
                # fmt: off
                "–≠–∫–æ–∫–æ–∂–∞ —á–µ—Ä–Ω–∞—è": ["051", "054", "072", "079", "085", "395"],
                "–î–∂–µ—Ä—Å–∏ —á–µ—Ä–Ω–∞—è": ["001", "002", "003", "004", "005", "050", "122"],
                "–≠–∫–æ–∫–æ–∂–∞ —Ü–≤–µ—Ç–Ω–∞—è": ["052", "053", "056", "057", "058", "059", "060", "061", "062", "063", "064",
                                    "065", "066", "067", "068", "069", "070", "071", "073", "074", "075", "076",
                                    "077", "078", "080", "081", "082", "083", "084", "093", "100", "102",
                                    "103", "123", "101"],
                "–î–∂–µ—Ä—Å–∏ —Ü–≤–µ—Ç–Ω–∞—è": ["006", "007", "008", "009", "010", "011", "012", "013", "014", "015", "016",
                                "017", "018", "019", "020", "021", "022", "023", "024", "025", "026", "027",
                                "028", "029", "030", "031", "032", "033", "034", "035", "036", "037", "038",
                                "039", "040", "041", "042", "043", "044", "045", "046", "047", "048", "049",
                                "055", "086", "087", "088", "089", "090", "091", "092", "094", "095", "096",
                                "097", "098", "099", "104", "105", "106", "107", "108", "109", "110", "111",
                                "112", "113", "114", "115", "116", "117", "118", "119", "120", "121", "131",
                                "132", "133", "281", "341", "342", "343", "344", "345", "346", "347", "348",
                                "349", "350", "351", "354", "355", "356", "357", "358", "387"],
                "–î–∂–µ—Ä—Å–∏ –ö–æ—Ä–æ—Ç–∫–∞—è –ß–µ—Ä–Ω–∞—è (40,50)": ["352", "353", "392", "395"],
                "–°–æ—Ñ—Ç –ª–µ—Ç–æ": ["203", "197", "206", "168", "169", "170", "171", "172", "173", "174", "175", "176",
                            "177", "178", "179", "180", "181", "182", "183", "184", "185", "186", "187", "188",
                            "189", "190", "191", "192", "193", "194", "195", "196", "197", "198", "199", "200",
                            "201", "202", "203", "204", "205", "206", "207", "208", "209", "210", "211", "212",
                            "213", "225", "226", "227", "228", "229", "230", "232", "233", "234", "235", "236",
                            "237", "238", "239", "240", "241", "242", "243", "244", "245", "246", "247", "248",
                            "249", "250", "251", "252", "253", "254", "255", "256", "258", "259", "260", "261",
                            "262", "263", "264", "265", "266", "267", "268", "269", "270", "271", "272", "273",
                            "274", "275", "276", "277", "278", "279", "280", "282", "283", "284", "285", "286",
                            "287", "288", "289", "290", "291", "292", "293", "294", "295", "296", "297", "298",
                            "299", "300", "301", "302", "303", "304", "305", "306", "307", "308", "309", "310",
                            "311", "312", "313", "314", "315", "317", "318", "319", "320", "321", "322", "323",
                            "324", "325", "326", "328", "329", "330", "331", "332", "333", "334", "335", "336",
                            "337", "338", "340", "359", "360", "361", "362", "363", "364", "365", "366", "367",
                            "368", "369", "370", "371", "372", "373", "374", "375", "376", "377", "378", "379",
                            "380", "381", "382", "383", "385", "386", "224"],
                "–î—Ä—É–≥–æ–µ": ["124", "125", "126", "127", "128", "129", "130", "134", "135", "136", "137", "138", 
                        "139", "140", "141", "142", "143", "144", "145", "146", "147", "148", "149", "150",
                        "151", "152", "153", "154", "155", "156", "157", "158", "159", "160", "161", "162",
                        "163", "164", "165", "166", "167", "214", "215", "216", "217", "218", "219", "220",
                        "221", "222", "223", "339"],
                # fmt: on
                # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–¥–µ—Å—å
            }
            # –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞
            all_add_log = (
                df.groupby("–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã")
                .agg(
                    {
                        "–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é": "sum",
                        "–û–±—â–∞—è —Å—É–º–º–∞ —à—Ç—Ä–∞—Ñ–æ–≤": "sum",
                        "–•—Ä–∞–Ω–µ–Ω–∏–µ": "sum",
                        "–£–¥–µ—Ä–∂–∞–Ω–∏—è": "sum",
                        "–ü–ª–∞—Ç–Ω–∞—è –ø—Ä–∏–µ–º–∫–∞": "sum",
                    }
                )
                .reset_index()
            )

            totall_summary = pd.DataFrame(
                {
                    "–ö–æ–ª–æ–Ω–∫–∞": [
                        "–õ–æ–≥–∏—Å—Ç–∏–∫–∞",
                        "–°—É–º–º–∞ –°–ü–ü",
                        "–°—É–º–º–∞ –ß–∏—Å—Ç—ã—Ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–π –±–µ–∑ –í–æ–∑–≤—Ä–∞—Ç–æ–≤ –∏ –õ–æ–≥–∏—Å—Ç–∏–∫–∏",
                        "–ß–∏—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —à—Ç",
                        "–ó–∞–∫–∞–∑—ã",
                        "–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–¥–∞–∂",
                        "–ü—Ä–∏–±—ã–ª—å –±–µ–∑ –Ω–∞–ª–æ–≥–∞",
                        "–®—Ç—Ä–∞—Ñ—ã",
                        "–•—Ä–∞–Ω–µ–Ω–∏–µ",
                        "–£–¥–µ—Ä–∂–∞–Ω–∏—è",
                        "–ü–ª–∞—Ç–Ω–∞—è –ø—Ä–∏–µ–º–∫–∞",
                        "–ò—Ç–æ–≥–æ: –ø—Ä–∏–±—ã–ª—å –º–∏–Ω—É—Å –¥–æ–ø. —É–¥–µ—Ä–∂–∞–Ω–∏—è",
                    ],
                    "–û–±—â–∞—è —Å—É–º–º–∞": [
                        third_merged["–õ–æ–≥–∏—Å—Ç–∏–∫–∞"].sum(),
                        third_merged["–°—É–º–º–∞ –°–ü–ü"].sum(),
                        third_merged["–ß–∏—Å—Ç–æ–µ –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –±–µ–∑ –õ–æ–≥–∏—Å—Ç–∏–∫–∏"].sum(),
                        third_merged["–ß–∏—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —à—Ç"].sum(),
                        third_merged["–ó–∞–∫–∞–∑—ã"].sum(),
                        third_merged["–°–µ–±–µ—Å –ü—Ä–æ–¥–∞–∂"].sum(),
                        third_merged["–ü—Ä–∏–±—ã–ª—å"].sum(),
                        all_add_log["–û–±—â–∞—è —Å—É–º–º–∞ —à—Ç—Ä–∞—Ñ–æ–≤"].sum(),
                        all_add_log["–•—Ä–∞–Ω–µ–Ω–∏–µ"].sum(),
                        all_add_log["–£–¥–µ—Ä–∂–∞–Ω–∏—è"].sum(),
                        all_add_log["–ü–ª–∞—Ç–Ω–∞—è –ø—Ä–∏–µ–º–∫–∞"].sum(),
                        third_merged["–ü—Ä–∏–±—ã–ª—å"].sum()
                        - (
                            all_add_log["–û–±—â–∞—è —Å—É–º–º–∞ —à—Ç—Ä–∞—Ñ–æ–≤"].sum()
                            + all_add_log["–•—Ä–∞–Ω–µ–Ω–∏–µ"].sum()
                            + all_add_log["–£–¥–µ—Ä–∂–∞–Ω–∏—è"].sum()
                            + all_add_log["–ü–ª–∞—Ç–Ω–∞—è –ø—Ä–∏–µ–º–∫–∞"].sum()
                        ),
                    ],
                }
            )

            sum_dop_uderzhany = (
                all_add_log["–û–±—â–∞—è —Å—É–º–º–∞ —à—Ç—Ä–∞—Ñ–æ–≤"].sum()
                + all_add_log["–•—Ä–∞–Ω–µ–Ω–∏–µ"].sum()
                + all_add_log["–£–¥–µ—Ä–∂–∞–Ω–∏—è"].sum()
                + all_add_log["–ü–ª–∞—Ç–Ω–∞—è –ø—Ä–∏–µ–º–∫–∞"].sum()
            )

            sum_zakaz = third_merged["–ó–∞–∫–∞–∑—ã"].sum()

            third_merged["–î–æ–ø —É–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–∞ –∫–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤ 1 –ê—Ä—Ç–∏–∫—É–ª–∞"] = (
                (sum_dop_uderzhany / sum_zakaz) * third_merged["–ó–∞–∫–∞–∑—ã"]
            ).round(1)

            third_merged["–ü—Ä–∏–±—ã–ª—å"] = (
                third_merged["–ú–∞—Ä–∂–∞"]
                - third_merged["–ù–∞–ª–æ–≥–∏"]
                - third_merged["–î–æ–ø —É–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–∞ –∫–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤ 1 –ê—Ä—Ç–∏–∫—É–ª–∞"]
            ).round(1)

            # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–¥–∞–∂–∏ (–ß–∏—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —à—Ç > 0) ‚Üí –¥–µ–ª–∏–º –ü—Ä–∏–±—ã–ª—å –Ω–∞ –ü—Ä–æ–¥–∞–∂–∏
            # –ï—Å–ª–∏ –ø—Ä–æ–¥–∞–∂ –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å –∑–∞–∫–∞–∑—ã (–ó–∞–∫–∞–∑—ã > 0) ‚Üí –¥–µ–ª–∏–º –ü—Ä–∏–±—ã–ª—å –Ω–∞ –ó–∞–∫–∞–∑—ã
            # –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ –ø—Ä–æ–¥–∞–∂, –Ω–∏ –∑–∞–∫–∞–∑–æ–≤ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 0
            third_merged["–ü—Ä–∏–±—ã–ª—å –Ω–∞ 1 –Æ–±–∫—É"] = (
                third_merged.apply(
                    lambda row: (
                        (row["–ü—Ä–∏–±—ã–ª—å"] / row["–ß–∏—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —à—Ç"])
                        if row["–ß–∏—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —à—Ç"] > 0
                        else (
                            (row["–ü—Ä–∏–±—ã–ª—å"] / row["–ó–∞–∫–∞–∑—ã"]) if row["–ó–∞–∫–∞–∑—ã"] > 0 else 0
                        )
                    ),
                    axis=1,
                )
                .replace([np.inf, -np.inf], 0)  # –∑–∞–º–µ–Ω–∞ ¬±–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–µ–π
                .fillna(0)  # –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç NaN
                .round(1)
            )

            third_merged["% –°–ü–ü"] = (
                (third_merged["–°–ü–ü –°—Ä–µ–¥–Ω—è—è"] / third_merged["–ù–∞—à–∞ —Ü–µ–Ω–∞ –°—Ä–µ–¥–Ω—è—è"]) * 100
            ).round(1)

            # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ü—Ä–∏–±—ã–ª–∏
            third_merged.sort_values(by="–ü—Ä–∏–±—ã–ª—å", ascending=False, inplace=True)

            # –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –Ω—É–ª–µ–≤–æ–π –ø—Ä–∏–±—ã–ª—å—é
            third_merged = third_merged[third_merged["–ü—Ä–∏–±—ã–ª—å"] != 0].copy()

            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Excel —Ñ–∞–π–ª–∞
            output = BytesIO()

            # summary_soft.to_excel(writer, sheet_name="–°–æ—Ñ—Ç —Ç–æ–≤–∞—Ä—ã", index=False)
            with pd.ExcelWriter(output, engine="openpyxl") as writer:
                # –õ–∏—Å—Ç "–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"
                third_merged.to_excel(
                    writer,
                    sheet_name="–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ",
                    index=False,
                    columns=existing_columns,
                )

                # –õ–∏—Å—Ç "–ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞"
                totall_summary.to_excel(
                    writer, sheet_name="–ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞", index=False
                )

                # –õ–∏—Å—Ç—ã —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
                for category, prefixes in categories.items():
                    # –§–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ –ü—Ä–µ—Ñ–∏–∫—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ –¥–ª—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    filtered = third_merged[third_merged["–ü—Ä–µ—Ñ–∏–∫—Å"].isin(prefixes)]

                    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é
                    filtered = filtered.drop(columns=["–ü—Ä–µ—Ñ–∏–∫—Å"])

                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏ –∏–º—è –ª–∏—Å—Ç–∞ 31 —Å–∏–º–≤–æ–ª (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Excel)
                    safe_sheet_name = category[:31]

                    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ª–∏—Å—Ç
                    filtered.to_excel(writer, sheet_name=safe_sheet_name, index=False)
                    # === –ö–û–†–†–ï–ö–¢–ò–†–û–í–ö–ê –î–õ–Ø –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –õ–ò–°–¢–ê ===
                    target_category = "–î–∂–µ—Ä—Å–∏ –ö–æ—Ä–æ—Ç–∫–∞—è –ß–µ—Ä–Ω–∞—è (40,50)"
                    if category == target_category:
                        ws = writer.sheets[safe_sheet_name]

                        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ –∫–æ–ª–æ–Ω–æ–∫
                        col_names = {
                            col: idx for idx, col in enumerate(filtered.columns, 1)
                        }  # 1-based

                        try:
                            qty_col = col_names["–ß–∏—Å—Ç—ã–µ –ø—Ä–æ–¥–∞–∂–∏, —à—Ç"]
                            cost_col = col_names["–°–µ–±–µ—Å –ü—Ä–æ–¥–∞–∂"]
                            margin_col = col_names["–ú–∞—Ä–∂–∞"]
                            tax_col = col_names["–ù–∞–ª–æ–≥–∏"]
                            extra_deduction_col = col_names[
                                "–î–æ–ø —É–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–∞ –∫–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤ 1 –ê—Ä—Ç–∏–∫—É–ª–∞"
                            ]
                            profit_col = col_names["–ü—Ä–∏–±—ã–ª—å"]
                            # === üî• –ü–ï–†–ï–ò–ú–ï–ù–û–í–´–í–ê–ï–ú –ó–ê–ì–û–õ–û–í–û–ö –ö–û–õ–û–ù–ö–ò ===
                            cost_col_letter = get_column_letter(cost_col)
                            ws[f"{cost_col_letter}1"] = "–°–µ–±–µ—Å –ü—Ä–æ–¥–∞–∂ (400—Ä)"

                            # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏ (–Ω–∞—á–∏–Ω–∞—è —Å–æ 2-–π, —Ç.–∫. 1-—è ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫)
                            for row_idx in range(2, len(filtered) + 2):
                                # 1. –ù–æ–≤–∞—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å = –∫–æ–ª-–≤–æ * 500
                                qty_cell = f"{get_column_letter(qty_col)}{row_idx}"
                                cost_cell = f"{get_column_letter(cost_col)}{row_idx}"
                                ws[cost_cell] = f"={qty_cell}*400"

                                # 2. –ú–∞—Ä–∂–∞ = –ß–∏—Å—Ç–æ–µ –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –±–µ–∑ –õ–æ–≥–∏—Å—Ç–∏–∫–∏ - –°–µ–±–µ—Å –ü—Ä–æ–¥–∞–∂
                                clean_payment_col = col_names[
                                    "–ß–∏—Å—Ç–æ–µ –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –±–µ–∑ –õ–æ–≥–∏—Å—Ç–∏–∫–∏"
                                ]
                                clean_payment_cell = (
                                    f"{get_column_letter(clean_payment_col)}{row_idx}"
                                )
                                margin_cell = (
                                    f"{get_column_letter(margin_col)}{row_idx}"
                                )
                                ws[margin_cell] = f"={clean_payment_cell}-{cost_cell}"

                                # 3. –ü—Ä–∏–±—ã–ª—å = –ú–∞—Ä–∂–∞ - –ù–∞–ª–æ–≥–∏ - –î–æ–ø —É–¥–µ—Ä–∂–∞–Ω–∏–µ
                                tax_cell = f"{get_column_letter(tax_col)}{row_idx}"
                                extra_cell = (
                                    f"{get_column_letter(extra_deduction_col)}{row_idx}"
                                )
                                profit_cell = (
                                    f"{get_column_letter(profit_col)}{row_idx}"
                                )
                                ws[profit_cell] = (
                                    f"={margin_cell}-{tax_cell}-{extra_cell}"
                                )

                        except KeyError as e:
                            print(f"–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞: {e}")

                # –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏ –¥—Ä—É–≥–∏–µ –ª–∏—Å—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, summary_soft)

                # –ì—Ä—É–ø–ø—ã –ø–æ –ø—Ä–∏–±—ã–ª–∏

                for category in categories_profit:
                    filtered = third_merged[
                        third_merged["–ì—Ä—É–ø–ø–∞ –ø–æ –ø—Ä–∏–±—ã–ª–∏"] == category
                    ]
                    safe_sheet_name = category[
                        :31
                    ]  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Excel –Ω–∞ –¥–ª–∏–Ω—É –∏–º–µ–Ω–∏ –ª–∏—Å—Ç–∞
                    filtered.to_excel(writer, sheet_name=safe_sheet_name, index=False)

                # ===== –î–û–ë–ê–í–õ–ï–ù–û: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ =====
                workbook = writer.book  # –ü–æ–ª—É—á–∞–µ–º workbook –∏–∑ write
                # –°—Ç–∏–ª—å –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
                header_style = NamedStyle(
                    name="header_style",
                    alignment=Alignment(
                        wrap_text=True, horizontal="center", vertical="center"
                    ),
                    font=Font(bold=True),
                )
                # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ –≤—Å–µ–º –ª–∏—Å—Ç–∞–º
                for sheetname in writer.sheets:
                    sheet = writer.sheets[sheetname]

                    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª—å –∫ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ (–∑–∞–≥–æ–ª–æ–≤–∫–∞–º)
                    for cell in sheet[1]:  # [1] - –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞
                        cell.style = header_style

                    # –ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                    for column in sheet.columns:
                        max_length = max(
                            (
                                len(str(cell.value)) if cell.value else 0
                                for cell in column[1:]  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                            ),
                            default=0,
                        )
                        sheet.column_dimensions[column[0].column_letter].width = min(
                            max_length + 10, 65
                        )  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —à–∏—Ä–∏–Ω—É

            output.seek(0)

            response = HttpResponse(
                output.getvalue(),
                content_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            )
            response["Content-Disposition"] = (
                'attachment; filename="wildberries_report_Form_2_.xlsx"'
            )
            return response

        except Exception as e:
            import traceback

            traceback.print_exc()
            return render(
                request,
                "forms_app/form2.html",
                {"error": f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ: {str(e)}"},
            )

    return render(request, "forms_app/form2.html")
